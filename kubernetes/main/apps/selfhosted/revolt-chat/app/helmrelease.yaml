---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: revolt-chat
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    controllers:
      revolt-chat:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          client:
            image:
              repository: ghcr.io/revoltchat/client
              tag: master@sha256:a85749fdb93e9c7170f38a7fad158b3066648db9d1890bc81f38ccb2856192c7
            env:
              REVOLT_APP_URL: https://revolt.sillock.io
              REVOLT_EXTERNAL_WS_URL: wss://revolt.sillock.io/ws
              REVOLT_PUBLIC_URL: http://revolt.sillock.io/api
              VITE_API_URL: http://revolt.sillock.io/api
              REVOLT_EXTERNAL_WS_URL: ws://revolt.sillock.io/ws
              AUTUMN_PUBLIC_URL: http://revolt.sillock.io/autumn
              JANUARY_PUBLIC_URL: http://revolt.sillock.io/january
              HOSTNAME: revolt.sillock.io
              REVOLT_INVITE_ONLY: 1
              REVOLT_MAX_GROUP_SIZE: 50
            envFrom:
              - secretRef:
                  name: revolt-chat-secret
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          api:
            image:
              repository: ghcr.io/revoltchat/server
              tag: 20240830-1@sha256:d029af6dec35e200f9b5333b99b7932d3b80be23b38e41c25c418ae392568fe2
            envFrom:
              - secretRef:
                  name: revolt-chat-secret
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          events:
            image:
              repository: ghcr.io/revoltchat/bonfire
              tag: 20240909-2@sha256:e0b50a675636b3605ec9a7c66fdc88966b652b098b33e43f05da8df4b2fb20b1
            envFrom:
              - secretRef:
                  name: revolt-chat-secret
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          file-storage:
            image:
              repository: ghcr.io/revoltchat/autumn
              tag: 20240911-beta-test@sha256:84cedbb8c7086cf0ba57e669c3874758b6a38284b7df1420a0322f4ad03d006d
            envFrom:
              - secretRef:
                  name: revolt-chat-secret
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          image-proxy:
            image:
              repository: ghcr.io/revoltchat/january
              tag: master@sha256:2d13849feaeca07cefa00dcc7f2f9c7850bc2a623f10a17ba993c1b095f64d33
            envFrom:
              - secretRef:
                  name: revolt-chat-secret
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          redis:
            image:
              repository: docker.io/library/redis
              tag: 7.4.0-alpine@sha256:c35af3bbcef51a62c8bae5a9a563c6f1b60d7ebaea4cb5a3ccbcc157580ae098
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
          mongo:
            image:
              repository: docker.io/amd64/mongo
              tag: 7.0.14@sha256:eefc27764e0edd0dd121804ce4caf249cb91ef18c9cd5ad415c8a3e31324ba69
            probes:
              liveness: &probes
                enabled: false
              readiness: *probes
              startup:
                enabled: false
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                memory: 500M
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 568
        runAsGroup: 568
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
        supplementalGroups: [44, 10000]
        seccompProfile: { type: RuntimeDefault }
    service:
      api:
        controller: revolt-chat
        ports:
          client:
            port: 5000
          api:
            port: 8000
          events:
            port: 9000
          file-storage:
            port: 3000
          image-proxy:
            port: 7000
          redis:
            port: 6379
          mongo:
            port: 27017
    ingress:
      client:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.sillock.io
        className: external
        hosts:
          - host: "revolt.sillock.io"
            paths:
              - path: /
                service:
                  identifier: client
                  port: client
      api:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.sillock.io
          nginx.ingress.kubernetes.io/rewrite-target: /$2
        className: external
        hosts:
          - host: "revolt.sillock.io"
            paths:
              - path: /api
                service:
                  identifier: api
                  port: api
      events:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.sillock.io
          nginx.ingress.kubernetes.io/rewrite-target: /$2
        className: external
        hosts:
          - host: "revolt.sillock.io"
            paths:
              - path: /ws
                service:
                  identifier: events
                  port: events
      file-storage:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.sillock.io
          nginx.ingress.kubernetes.io/rewrite-target: /$2
        className: external
        hosts:
          - host: "revolt.sillock.io"
            paths:
              - path: /autumn
                service:
                  identifier: file-storage
                  port: file-storage
      image-proxy:
        annotations:
          external-dns.alpha.kubernetes.io/target: external.sillock.io
          nginx.ingress.kubernetes.io/rewrite-target: /$2
        className: external
        hosts:
          - host: "revolt.sillock.io"
            paths:
              - path: /january
                service:
                  identifier: image-proxy
                  port: image-proxy
    persistence:
      revolt-chat-configfile:
        type: configMap
        name: revolt-chat-configmap
        advancedMounts:
          revolt-chat:
            api:
              - path: /Revolt.toml
            events:
              - path: /Revolt.toml
            client:
              - path: /Revolt.toml
            file-storage:
              - path: /Revolt.toml
            image-proxy:
              - path: /Revolt.toml
