---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: otel-collector
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: opentelemetry-collector
      version: 0.66.4
      sourceRef:
        kind: HelmRepository
        name: opentelemetry
        namespace: flux-system
      interval: 1m
  install:
    timeout: 10m
    replace: true
    crds: CreateReplace
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      remediateLastFailure: true
      retries: 3
      strategy: rollback
    cleanupOnFail: true
    crds: CreateReplace
  test:
    enable: true
  rollback:
    recreate: true
    force: true
    cleanupOnFail: true
  uninstall:
    keepHistory: false
  maxHistory: 3
  values:
    mode: daemonset
    presets:
      logsCollection:
        enabled: true
      kubernetesAttributes:
        enabled: true
      kubeletMetrics:
        enabled: true
      hostMetrics:
        enabled: true
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: ${env:MY_POD_IP}:4317
            http:
              endpoint: ${env:MY_POD_IP}:4318
      processors:
        resource:
          attributes:
            - action: insert
              key: loki.format
              value: raw
            - action: insert
              key: loki.resource.labels
              value: pod, namespace, container, cluster, filename

      exporters:
        logging:
          loglevel: debug
        # Logs
        loki:
          endpoint: http://loki:3100/loki/api/v1/push
        # Metrics
        prometheusremotewrite:
          endpoint: http://kube-prometheus-stack-prometheus:9090/api/v1/write
        # Traces
        jaeger:
          endpoint: http://jaeger-collector:14250
          tls:
            insecure: true

      service:
        pipelines:
          logs:
            receivers: [filelog, otlp]
            exporters: [logging, loki]
          metrics:
            receivers: [hostmetrics, kubeletstats, otlp]
            exporters: [prometheusremotewrite]
          traces:
            receivers: [otlp]
            exporters: [jaeger]
