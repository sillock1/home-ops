---
# yaml-language-server: $schema=https://kubernetes.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ${APP}-versitygw
spec:
  chartRef:
    kind: OCIRepository
    name: ${APP}-versitygw # overwritten by name reference transformer
  interval: 1h
  values:
    controllers:
      versitygw:
        annotations:
          reloader.stakater.com/auto: 'true'
        containers:
          app:
            args: ["posix", "/data"]
            env:
              - name: VGW_BACKEND
                value: posix
              - name: ROOT_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    key: AWS_ACCESS_KEY_ID
                    name: ${APP}
              - name: ROOT_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    key: AWS_SECRET_ACCESS_KEY
                    name: ${APP}
            image:
              repository: docker.io/versity/versitygw
              tag: v1.0.20@sha256:c2f9b9289d237b85736214dfbef376b7d092b8540e1456d547aaa35dd03ad0b3
            probes:
              liveness: &ref_0
                enabled: false
              readiness: *ref_0
            resources:
              limits:
                memory: 500Mi
              requests:
                cpu: 10m
                memory: 256Mi
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
              readOnlyRootFilesystem: false
    defaultPodOptions:
      securityContext:
        fsGroup: 2048
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 2048
        runAsNonRoot: true
        runAsUser: 2048
        seccompProfile:
          type: RuntimeDefault
    persistence:
      data:
        existingClaim: ${APP}-versitygw # overwritten by kustomizeconfig
    service:
      versitygw:
        controller: versitygw
        ports:
          http:
            port: 80
            targetPort: 7070
