---
# yaml-language-server: $schema=https://kubernetes.pages.dev/fluxcd.controlplane.io/resourceset_v1.json
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: dotbot
spec:
  inputsFrom:
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSetInputProvider
      name: dotbot-github-prs
  resources:
    - apiVersion: v1
      kind: ConfigMap
      metadata:
        name: dotbot-override-helm-values-pr-<< inputs.id >>
      data:
        values.yaml: |-
          controllers:
            migration:
              containers:
                init:
                  image:
                    tag: << inputs.branch | replace "/" "-" >>-<< inputs.sha >>
                  env:
                    - name: DB_HOSTNAME
                      valueFrom:
                        secretKeyRef:
                          name: dotbot-database-pr-<< inputs.id >>-app
                          key: host
                    - name: DB_USER
                      valueFrom:
                        secretKeyRef:
                          name: dotbot-database-pr-<< inputs.id >>-app
                          key: user
                    - name: DB_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: dotbot-database-pr-<< inputs.id >>-app
                          key: password
                    - name: DB_DATABASE_NAME
                      valueFrom:
                        secretKeyRef:
                          name: dotbot-database-pr-<< inputs.id >>-app
                          key: dbname
                    - name: CONNECTIONSTRING
                      value: Host=$(DB_HOSTNAME);Port=5432;Database=$(DB_DATABASE_NAME);Username=$(DB_USER);Password=$(DB_PASSWORD);
          dotbot:
            containers:
              app:
                image:
                  tag: << inputs.branch | replace "/" "-" >>-<< inputs.sha >>
                envFrom:
                  - secretRef:
                      name: dotbot-preview
                env:
                  - name: DB_HOSTNAME
                    valueFrom:
                      secretKeyRef:
                        name: dotbot-database-pr-<< inputs.id >>-app
                        key: host
                  - name: DB_USER
                    valueFrom:
                      secretKeyRef:
                        name: dotbot-database-pr-<< inputs.id >>-app
                        key: user
                  - name: DB_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: dotbot-database-pr-<< inputs.id >>-app
                        key: password
                  - name: DB_DATABASE_NAME
                    valueFrom:
                      secretKeyRef:
                        name: dotbot-database-pr-<< inputs.id >>-app
                        key: dbname
                  - name: ConnectionStrings__dotbot
                    value: Host=$(DB_HOSTNAME);Port=5432;Database=$(DB_DATABASE_NAME);Username=$(DB_USER);Password=$(DB_PASSWORD);
                  - name: S3__ServiceURL
                    value: http://dotbot-versitygw-pr-<< inputs.id >>.opentoucan.svc.cluster.local
                  - name: S3__ForcePathStyle
                    value: true
                  - name: ConnectionStrings__redis
                    value: dotbot-dragonfly-pr-<< inputs.id >>.opentoucan.svc.cluster.local:6379,password=$(REDIS_PASSWORD)
          route:
            dotbot:
              hostnames:
                - "dotbot-<< inputs.id >>.${DOMAIN}"
              rules:
                - backendRefs:
                    - name: dotbot-<< inputs.id >>
    - apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: dotbot-pr-<< inputs.id >>
        namespace: opentoucan
      spec:
        commonMetadata:
          labels:
            app.kubernetes.io/name: dotbot-pr-<< inputs.id >>
          annotations:
            event.toolkit.fluxcd.io/preview-url: "https://dotbot-pr-<< inputs.id >>.${DOMAIN}/interactions"
            event.toolkit.fluxcd.io/pr-number: << inputs.id | quote >>
            event.toolkit.fluxcd.io/branch: << inputs.branch | replace "/" "-" | quote >>
            event.toolkit.fluxcd.io/author: << inputs.author | quote >>
        components:
          - ../../../../components/dragonfly
          - ../../../../components/postgres
          - ../../../../components/s3
        dependsOn:
          - name: external-secrets-store-onepassword
            namespace: external-secrets
        interval: 30m
        nameSuffix: -pr-<< inputs.id >>
        path: ./kubernetes/apps/base/opentoucan/dotbot
        postBuild:
          substitute:
            APP: dotbot
            DOMAIN: sillock.com
            OVERLAY_CONFIGMAP_NAME: dotbot-override-helm-values-pr-<< inputs.id >>
        prune: true
        sourceRef:
          kind: GitRepository
          name: flux-system
          namespace: flux-system
        targetNamespace: opentoucan
        timeout: 5m
        wait: false
