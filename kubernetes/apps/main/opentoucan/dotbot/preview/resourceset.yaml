---
# yaml-language-server: $schema=https://kubernetes.pages.dev/fluxcd.controlplane.io/resourceset_v1.json
apiVersion: fluxcd.controlplane.io/v1
kind: ResourceSet
metadata:
  name: dotbot
spec:
  inputsFrom:
    - apiVersion: fluxcd.controlplane.io/v1
      kind: ResourceSetInputProvider
      name: dotbot-github-prs
  resources:
    - apiVersion: kustomize.config.k8s.io/v1beta1
      kind: Kustomization
      configMapGenerator:
        - name: dotbot-override-helm-values-pr-<< inputs.id >>
          files:
            - values.yaml=./helm/values-template.yaml
      generatorOptions:
        disableNameSuffixHash: true
      replacements:
      - source:
          kind: ConfigMap
          name: dotbot-override-helm-values-pr-<< inputs.id >>
          fieldPath: metadata.name
        targets:
        - select:
            kind: HelmRelease
            name: dotbot-pr-<< inputs.id >>
          fieldPaths:
          - spec.valuesFrom.[name=dotbot-override-helm-values].name
    - apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: dotbot-pr-<< inputs.id >>
        namespace: opentoucan
      spec:
        commonMetadata:
          labels:
            app.kubernetes.io/name: dotbot-pr-<< inputs.id >>
          annotations:
            event.toolkit.fluxcd.io/preview-url: "https://dotbot-pr-<< inputs.id >>.${DOMAIN}/interactions"
            event.toolkit.fluxcd.io/pr-number: << inputs.id | quote >>
            event.toolkit.fluxcd.io/branch: << inputs.branch | replace "/" "-" | quote >>
            event.toolkit.fluxcd.io/author: << inputs.author | quote >>
        components:
          - ../../../../components/dragonfly
          - ../../../../components/postgres
          - ../../../../components/s3
        dependsOn:
          - name: external-secrets-store-onepassword
            namespace: external-secrets
        interval: 30m
        nameSuffix: -pr-<< inputs.id >>
        path: ./kubernetes/apps/base/opentoucan/dotbot
        postBuild:
          substitute:
            APP: dotbot
            DOMAIN: sillock.com
        prune: true
        sourceRef:
          kind: GitRepository
          name: flux-system
          namespace: flux-system
        targetNamespace: opentoucan
        timeout: 5m
        wait: false
